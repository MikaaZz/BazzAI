<%= render "shared/navbar" %>
<div class="container my-4 min-vh-100 align-content-center">
  <div class="row">
    <% if @recommendation.trailer_link.present? %>
      <div class="col-lg-12 mb-4">
        <div class="banner trailer">
          <div class="trailer-content">
            <iframe src="<%=@recommendation.trailer_link%>" frameborder="0" allowfullscreen></iframe>
          </div>
        </div>
      </div>
    <% end %>

    <div class="col-lg-8">
      <div class="recommendation-content">
        <h1><%= "#{@recommendation.movie_name} (#{@recommendation.year})" %></h1>
        <p>
          <strong>
            <%= link_to image_tag("https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/IMDB_Logo_2016.svg/1150px-IMDB_Logo_2016.svg.png?20200406194337", alt: "IMDb Logo", class: "imdb-logo", style: "width: 10%;"), "https://www.imdb.com/title/#{@recommendation.imdbID}", target: "_blank" %>
          </strong>
        </p>
        <p><strong>Genres:</strong></p>
        <div class="d-flex flex-wrap my-4">
          <% @recommendation.genre.split(',').each do |genre| %>
            <div class="p-1">
              <%= content_tag :span, genre.strip, class: "genre-button" %>
            </div>
          <% end %>
        </div>
        <p><strong>Runtime:</strong> <%= @recommendation.runtime %></p>
        <p><strong>imdB Score:</strong>
          <% @recommendation.imdb_score.to_i.times do %>
            ⭐️
          <% end %>
          <% (10 - @recommendation.imdb_score.to_i).times do %>
            ☆
          <% end %>
          (<%= @recommendation.imdb_score %> out of 10)
        </p>
        <p><strong>Synopsis:</strong> <%= @recommendation.synopsis %></p>
        <p><strong>Director(s):</strong> <%= @recommendation.director %></p>
        <p><strong>Writer(s):</strong> <%= @recommendation.writer %></p>
        <p><strong>Actors:</strong> <%= @recommendation.actors %></p>
        <p><strong>Awards:</strong> <%= @recommendation.awards %></p>
        <% streaming_info = @data['result']['streamingInfo'] %>
        <% if streaming_info.present? %>
          <% subscriptions_present = false %>
          <% streaming_info.each do |country, platforms| %>
            <% platforms.each do |platform, options| %>
              <% if options.any? { |option| option['type'] == 'subscription' } %>
                <% subscriptions_present = true %>
                <% break %>
              <% end %>
            <% end %>
            <% break if subscriptions_present %>
          <% end %>
          <% if subscriptions_present %>
            <div class="section">
              Subscriptions:
              <div class="d-flex flex-wrap my-4">
                <% subscriptions = [] %>
                <% streaming_info.each do |country, platforms| %>
                  <% platforms.each do |platform, options| %>
                    <% if options.any? { |option| option['type'] == 'subscription' } %>
                      <% image = case platform
                        when 'apple'
                          image_tag "Apple.png", class: "better-streaming-logo"
                        when 'disney'
                          image_tag "Disney.png", class: "better-streaming-logo"
                        when 'mubi'
                          image_tag "mubi.png", class: "better-streaming-logo"
                        when 'netflix'
                          image_tag "Netflix.png", class: "better-streaming-logo"
                        when 'prime'
                          image_tag "Amazon Prime.png", class: "better-streaming-logo"
                        when 'hbo'
                          image_tag "HBO Max.png", class: "better-streaming-logo"
                        when 'hulu'
                          image_tag "Hulu.png", class: "better-streaming-logo"
                        when 'peacock'
                          image_tag "Peacock.png", class: "better-streaming-logo"
                        when 'youtube'
                          image_tag "YouTube.png", class: "better-streaming-logo"
                        when 'wow'
                          image_tag "wow.png", class: "better-streaming-logo"
                        end
                      %>
                      <% options.each do |option| %>
                        <% if option['type'] == 'subscription' %>
                          <% has_subscription = true %>
                          <% link = option['link'] %>
                          <% price = option['price'] %>
                          <% availability_quality = option['quality'] %>
                          <% availability_text = "Subscription (#{availability_quality}):" %>
                          <% if link.present? && !subscriptions.include?(platform)  %>
                            <div class="platform">
                              <%= link_to image, link, target: "_blank" %>
                              <br>
                              <%= link_to "Watch Now", link, target: "_blank", class: "text-decoration-none text-white" %>
                            </div>
                            <% subscriptions << platform %>
                          <% end %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
          <% rentals_present = false %>
          <% streaming_info.each do |country, platforms| %>
            <% platforms.each do |platform, options| %>
              <% if options.any? { |option| option['type'] == 'rental' } %>
                <% rentals_present = true %>
                <% break %>
              <% end %>
            <% end %>
            <% break if rentals_present %>
          <% end %>
          <% if rentals_present %>
          <div class="section">
            Rentals:
            <div class="d-flex flex-wrap my-4">
              <% rentals = [] %>
              <% streaming_info.each do |country, platforms| %>
                <% platforms.each do |platform, options| %>
                  <% if options.any? { |option| option['type'] == 'rent' } %>
                    <% image = case platform
                      when 'apple'
                        image_tag "Apple.png", class: "better-streaming-logo"
                      when 'disney'
                        image_tag "Disney.png", class: "better-streaming-logo"
                      when 'mubi'
                        image_tag "mubi.png", class: "better-streaming-logo"
                      when 'netflix'
                        image_tag "Netflix.png", class: "better-streaming-logo"
                      when 'prime'
                        image_tag "Amazon Prime.png", class: "better-streaming-logo"
                      when 'hbo'
                        image_tag "HBO Max.png", class: "better-streaming-logo"
                      when 'hulu'
                        image_tag "Hulu.png", class: "better-streaming-logo"
                      when 'peacock'
                        image_tag "Peacock.png", class: "better-streaming-logo"
                      when 'youtube'
                        image_tag "YouTube.png", class: "better-streaming-logo"
                      when 'wow'
                        image_tag "wow.png", class: "better-streaming-logo"
                      end
                    %>
                    <% options.each do |option| %>
                      <% if option['type'] == 'rent' %>
                        <% has_rent = true %>
                        <% link = option['link'] %>
                        <% price = option['price'] %>
                        <% if link.present? && !rentals.include?(platform) %>
                          <div class="platform">
                            <%= image %>
                            <br>
                            <% if price.present? %>
                              <%= link_to "Rent Now (#{price['formatted']})", link, target: "_blank", class: "watch-button" %>
                            <% else %>
                              <%= link_to "Rent Now", link, target: "_blank", class: "watch-button" %>
                            <% end %>
                          </div>
                          <% rentals << platform %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
          <% purchases_present = false %>
          <% streaming_info.each do |country, platforms| %>
            <% platforms.each do |platform, options| %>
              <% if options.any? { |option| option['type'] == 'purchase' } %>
                <% purchases_present = true %>
                <% break %>
              <% end %>
            <% end %>
            <% break if purchases_present %>
          <% end %>
          <% if purchases_present %>
          <div class="section">
            <div class="d-flex flex-wrap my-4">
              <% purchases = [] %>
              <% streaming_info.each do |country, platforms| %>
                <% platforms.each do |platform, options| %>
                  <% if options.any? { |option| option['type'] == 'buy' || (option['type'] == 'addon' && platform == 'prime') } %>
                    <% image = case platform
                      when 'apple'
                        image_tag "Apple.png", class: "better-streaming-logo"
                      when 'disney'
                        image_tag "Disney.png", class: "better-streaming-logo"
                      when 'mubi'
                        image_tag "mubi.png", class: "better-streaming-logo"
                      when 'netflix'
                        image_tag "Netflix.png", class: "better-streaming-logo"
                      when 'prime'
                        image_tag "Amazon Prime.png", class: "better-streaming-logo"
                      when 'hbo'
                        image_tag "HBO Max.png", class: "better-streaming-logo"
                      when 'hulu'
                        image_tag "Hulu.png", class: "better-streaming-logo"
                      when 'peacock'
                        image_tag "Peacock.png", class: "better-streaming-logo"
                      when 'youtube'
                        image_tag "YouTube.png", class: "better-streaming-logo"
                      when 'wow'
                        image_tag "wow.png", class: "better-streaming-logo"
                      end
                    %>
                    <% options.each do |option| %>
                      <% if option['type'] == 'buy' || (option['type'] == 'addon' && platform == 'prime') %>
                        <% has_buy = true %>
                        <% link = option['link'] %>
                        <% price = option['price'] %>
                        <% if option['type'] == 'buy' && link.present? && !purchases.include?(platform) %>
                          <div class="platform">
                            <%= image %>
                            <br>
                            <% if price.present? %>
                              <%= link_to "Buy Now (#{price['formatted']})", link, target: "_blank", class: "watch-button" %>
                            <% else %>
                              <%= link_to "Buy Now", link, target: "_blank", class: "watch-button" %>
                            <% end %>
                          </div>
                          <% purchases << platform %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
        <br>
        <br>
        <p>
          <%= image_tag "bazzy_avatar.png", alt: "cutest mascot in the world", class: "bazzy-display", id: "bazzy-index" %>
        </p>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="sticky-poster">
        <%= link_to image_tag(@recommendation.image, alt: "#{@recommendation.movie_name} Poster"), "https://www.imdb.com/title/#{@recommendation.imdbID}", target: "_blank" %>
      </div>
    </div>
  </div>
</div>
